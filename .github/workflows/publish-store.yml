name: Publish to Microsoft Store

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  publish:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Install MAUI workloads
        run: dotnet workload install maui

      - name: Restore
        run: dotnet restore Gallery.App/Gallery.App.csproj

      - name: Build MSIX
        run: |
          dotnet publish Gallery.App/Gallery.App.csproj `
            --configuration Release `
            -p:TargetFramework=net9.0-windows10.0.19041.0 `
            -p:RuntimeIdentifierOverride=win10-x64 `
            -p:GenerateAppxPackageOnBuild=true `
            -p:AppxPackageSigningEnabled=false

      - name: Install Microsoft Store CLI
        run: dotnet tool install -g MSStore.CLI

      - name: Configure Store CLI
        run: msstore reconfigure --tenantId ${{ secrets.AZURE_TENANT_ID }} --clientId ${{ secrets.AZURE_CLIENT_ID }} --clientSecret ${{ secrets.AZURE_CLIENT_SECRET }} --sellerId ${{ secrets.SELLER_ID }}

      - name: Publish to Store
        run: |
          $msix = Get-ChildItem -Path . -Filter "*.msix" -Recurse | Select-Object -First 1
          msstore publish $msix.FullName
