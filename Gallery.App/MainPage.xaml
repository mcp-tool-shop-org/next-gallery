<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:Gallery.App.ViewModels"
             xmlns:views="clr-namespace:Gallery.App.Views"
             xmlns:converters="clr-namespace:Gallery.App.Converters"
             xmlns:selectors="clr-namespace:Gallery.App.TemplateSelectors"
             xmlns:domain="clr-namespace:Gallery.Domain.Models;assembly=Gallery.Domain"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             x:Class="Gallery.App.MainPage"
             x:DataType="vm:MainViewModel"
             Title="NextGallery"
             BackgroundColor="{StaticResource Gray950}">

    <ContentPage.Resources>
        <converters:FilePathToImageSourceConverter x:Key="FilePathConverter" />
        <converters:FileSizeConverter x:Key="FileSizeConverter" />
        <converters:IsNullOrEmptyConverter x:Key="IsNullOrEmptyConverter" />
        <converters:IsNotNullOrEmptyConverter x:Key="IsNotNullOrEmptyConverter" />
        <converters:BoolToColorConverter x:Key="BoolToColorConverter" />
        <converters:DurationConverter x:Key="DurationConverter" />
        <converters:IsVideoConverter x:Key="IsVideoConverter" />
        <converters:MediaTypeToIconConverter x:Key="MediaTypeToIconConverter" />
        <converters:IsImageConverter x:Key="IsImageConverter" />
        <converters:FilePathToMediaSourceConverter x:Key="MediaSourceConverter" />
        <converters:InverseBoolConverter x:Key="InverseBoolConverter" />

        <!-- Selection highlight style -->
        <Style x:Key="GridItemStyle" TargetType="Border">
            <Setter Property="BackgroundColor" Value="{StaticResource Gray800}" />
            <Setter Property="StrokeThickness" Value="0" />
            <Setter Property="Padding" Value="0" />
            <Setter Property="HeightRequest" Value="140" />
            <Setter Property="WidthRequest" Value="140" />
        </Style>
    </ContentPage.Resources>

    <Grid>
        <!-- Main content -->
        <Grid ColumnDefinitions="220,*,320" RowDefinitions="Auto,*,Auto">

            <!-- Header Bar -->
            <Grid Grid.Row="0" Grid.ColumnSpan="3"
                  BackgroundColor="{StaticResource Gray900}"
                  Padding="12,8">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <Label Grid.Column="0"
                       Text="NextGallery"
                       FontSize="20"
                       FontAttributes="Bold"
                       TextColor="{StaticResource White}"
                       VerticalOptions="Center" />

                <!-- Search and Filters -->
                <HorizontalStackLayout Grid.Column="1"
                                       HorizontalOptions="Center"
                                       Spacing="12">
                    <!-- Search Box -->
                    <Border BackgroundColor="{StaticResource Gray800}"
                            StrokeThickness="0"
                            Padding="8,4"
                            WidthRequest="280">
                        <Grid ColumnDefinitions="Auto,*,Auto">
                            <Label Grid.Column="0"
                                   Text="ðŸ”"
                                   FontSize="14"
                                   TextColor="{StaticResource Gray400}"
                                   VerticalOptions="Center"
                                   Margin="0,0,8,0" />
                            <Entry Grid.Column="1"
                                   Text="{Binding SearchText}"
                                   Placeholder="Search filename..."
                                   PlaceholderColor="{StaticResource Gray500}"
                                   TextColor="{StaticResource White}"
                                   BackgroundColor="Transparent"
                                   FontSize="13" />
                            <Button Grid.Column="2"
                                    Text="Ã—"
                                    Command="{Binding ClearSearchCommand}"
                                    BackgroundColor="Transparent"
                                    TextColor="{StaticResource Gray400}"
                                    FontSize="16"
                                    Padding="4"
                                    WidthRequest="28"
                                    HeightRequest="28"
                                    IsVisible="{Binding SearchText, Converter={StaticResource IsNotNullOrEmptyConverter}}" />
                        </Grid>
                    </Border>

                    <!-- Filter Buttons -->
                    <HorizontalStackLayout Spacing="4">
                        <Button Text="â˜…"
                                Command="{Binding ToggleFavoritesFilterCommand}"
                                BackgroundColor="{Binding FavoritesOnly, Converter={StaticResource BoolToColorConverter}}"
                                TextColor="{StaticResource White}"
                                FontSize="14"
                                WidthRequest="36"
                                HeightRequest="32"
                                Padding="0"
                                CornerRadius="4" />
                        <Button Text="All"
                                Command="{Binding SetMediaTypeAllCommand}"
                                BackgroundColor="{StaticResource Gray700}"
                                TextColor="{StaticResource White}"
                                FontSize="11"
                                HeightRequest="32"
                                Padding="8,0"
                                CornerRadius="4" />
                        <Button Text="Images"
                                Command="{Binding SetMediaTypeImagesCommand}"
                                BackgroundColor="{StaticResource Gray700}"
                                TextColor="{StaticResource White}"
                                FontSize="11"
                                HeightRequest="32"
                                Padding="8,0"
                                CornerRadius="4" />
                        <Button Text="Videos"
                                Command="{Binding SetMediaTypeVideosCommand}"
                                BackgroundColor="{StaticResource Gray700}"
                                TextColor="{StaticResource White}"
                                FontSize="11"
                                HeightRequest="32"
                                Padding="8,0"
                                CornerRadius="4" />
                    </HorizontalStackLayout>

                    <!-- Grouping Buttons -->
                    <Border BackgroundColor="{StaticResource Gray800}"
                            StrokeThickness="0"
                            Padding="2">
                        <HorizontalStackLayout Spacing="2">
                            <Button Text="ðŸ“‹"
                                    Command="{Binding SetGroupByNoneCommand}"
                                    BackgroundColor="{StaticResource Gray700}"
                                    TextColor="{StaticResource White}"
                                    FontSize="12"
                                    WidthRequest="32"
                                    HeightRequest="28"
                                    Padding="0"
                                    CornerRadius="4"
                                    ToolTipProperties.Text="Flat view" />
                            <Button Text="ðŸ“…"
                                    Command="{Binding SetGroupByDayCommand}"
                                    BackgroundColor="{StaticResource Gray700}"
                                    TextColor="{StaticResource White}"
                                    FontSize="12"
                                    WidthRequest="32"
                                    HeightRequest="28"
                                    Padding="0"
                                    CornerRadius="4"
                                    ToolTipProperties.Text="Group by day" />
                            <Button Text="ðŸ“†"
                                    Command="{Binding SetGroupByMonthCommand}"
                                    BackgroundColor="{StaticResource Gray700}"
                                    TextColor="{StaticResource White}"
                                    FontSize="12"
                                    WidthRequest="32"
                                    HeightRequest="28"
                                    Padding="0"
                                    CornerRadius="4"
                                    ToolTipProperties.Text="Group by month" />
                        </HorizontalStackLayout>
                    </Border>

                    <!-- Result Count -->
                    <Label Text="{Binding ResultSummary}"
                           TextColor="{StaticResource Gray400}"
                           FontSize="12"
                           VerticalOptions="Center" />
                </HorizontalStackLayout>

                <HorizontalStackLayout Grid.Column="2" Spacing="8">
                    <Button Text="Add Folder"
                            Command="{Binding AddFolderCommand}"
                            BackgroundColor="{StaticResource Primary}" />
                    <Button Text="Scan All"
                            Command="{Binding ScanAllCommand}"
                            BackgroundColor="{StaticResource Secondary}" />
                </HorizontalStackLayout>
            </Grid>

            <!-- Left Panel: Library Folders -->
            <Border Grid.Row="1" Grid.Column="0"
                    BackgroundColor="{StaticResource Gray900}"
                    Stroke="{StaticResource Gray800}"
                    StrokeThickness="0,0,1,0">
                <Grid RowDefinitions="Auto,*">
                    <Label Grid.Row="0"
                           Text="Library"
                           FontSize="14"
                           FontAttributes="Bold"
                           TextColor="{StaticResource Gray300}"
                           Margin="12,12,12,8" />

                    <CollectionView Grid.Row="1"
                                    ItemsSource="{Binding Folders}"
                                    SelectionMode="None">
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="domain:LibraryFolder">
                                <Grid Padding="12,6" ColumnDefinitions="*,Auto">
                                    <Label Text="{Binding Path}"
                                           TextColor="{StaticResource White}"
                                           FontSize="12"
                                           LineBreakMode="TailTruncation"
                                           VerticalOptions="Center" />
                                    <Button Grid.Column="1"
                                            Text="Ã—"
                                            FontSize="14"
                                            Padding="8,2"
                                            BackgroundColor="Transparent"
                                            TextColor="{StaticResource Gray500}"
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type vm:MainViewModel}}, Path=RemoveFolderCommand}"
                                            CommandParameter="{Binding .}" />
                                </Grid>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </Grid>
            </Border>

            <!-- Center: Image Grid (Flat mode) -->
            <CollectionView x:Name="ImageGrid"
                            Grid.Row="1" Grid.Column="1"
                            ItemsSource="{Binding Items}"
                            SelectedItem="{Binding SelectedItem, Mode=TwoWay}"
                            SelectionMode="Single"
                            SelectionChanged="OnGridSelectionChanged"
                            BackgroundColor="{StaticResource Gray950}"
                            IsVisible="{Binding IsGrouped, Converter={StaticResource InverseBoolConverter}}">
                <CollectionView.ItemsLayout>
                    <GridItemsLayout Orientation="Vertical"
                                     Span="6"
                                     HorizontalItemSpacing="4"
                                     VerticalItemSpacing="4" />
                </CollectionView.ItemsLayout>
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="domain:MediaItem">
                        <Border Style="{StaticResource GridItemStyle}">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer NumberOfTapsRequired="2"
                                                      Command="{Binding Source={RelativeSource AncestorType={x:Type vm:MainViewModel}}, Path=ToggleQuickPreviewCommand}" />
                            </Border.GestureRecognizers>
                            <Grid>
                                <!-- Thumbnail -->
                                <Image Source="{Binding ThumbSmallPath, Converter={StaticResource FilePathConverter}}"
                                       Aspect="AspectFill" />

                                <!-- Favorite indicator -->
                                <Label Text="â™¥"
                                       FontSize="16"
                                       TextColor="{StaticResource Primary}"
                                       HorizontalOptions="End"
                                       VerticalOptions="Start"
                                       Margin="4"
                                       IsVisible="{Binding IsFavorite}" />

                                <!-- Video overlay: play icon + duration -->
                                <Grid IsVisible="{Binding Type, Converter={StaticResource IsVideoConverter}}"
                                      HorizontalOptions="Fill"
                                      VerticalOptions="Fill">
                                    <!-- Play button icon (center) -->
                                    <Border BackgroundColor="#80000000"
                                            WidthRequest="36"
                                            HeightRequest="36"
                                            StrokeShape="RoundRectangle 18"
                                            StrokeThickness="0"
                                            HorizontalOptions="Center"
                                            VerticalOptions="Center">
                                        <Label Text="â–¶"
                                               FontSize="18"
                                               TextColor="{StaticResource White}"
                                               HorizontalOptions="Center"
                                               VerticalOptions="Center" />
                                    </Border>

                                    <!-- Duration badge (bottom-right) -->
                                    <Border BackgroundColor="#B0000000"
                                            Padding="4,2"
                                            StrokeThickness="0"
                                            HorizontalOptions="End"
                                            VerticalOptions="End"
                                            Margin="4"
                                            IsVisible="{Binding Duration, Converter={StaticResource IsNotNullOrEmptyConverter}}">
                                        <Label Text="{Binding Duration, Converter={StaticResource DurationConverter}}"
                                               FontSize="10"
                                               TextColor="{StaticResource White}" />
                                    </Border>
                                </Grid>

                                <!-- Placeholder when no thumb -->
                                <Border BackgroundColor="{StaticResource Gray700}"
                                        IsVisible="{Binding ThumbSmallPath, Converter={StaticResource IsNullOrEmptyConverter}}"
                                        HorizontalOptions="Fill"
                                        VerticalOptions="Fill">
                                    <!-- Show different icon for video vs image -->
                                    <Label Text="{Binding Type, Converter={StaticResource MediaTypeToIconConverter}}"
                                           FontSize="32"
                                           TextColor="{StaticResource Gray500}"
                                           HorizontalOptions="Center"
                                           VerticalOptions="Center" />
                                </Border>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

            <!-- Center: Virtualized Timeline Grid (Grouped mode) -->
            <CollectionView x:Name="TimelineGrid"
                            Grid.Row="1" Grid.Column="1"
                            ItemsSource="{Binding TimelineRows}"
                            BackgroundColor="{StaticResource Gray950}"
                            IsVisible="{Binding IsGrouped}">
                <CollectionView.ItemsLayout>
                    <LinearItemsLayout Orientation="Vertical" ItemSpacing="0" />
                </CollectionView.ItemsLayout>
                <CollectionView.ItemTemplate>
                    <selectors:TimelineRowTemplateSelector>
                        <!-- Group Header Template -->
                        <selectors:TimelineRowTemplateSelector.HeaderTemplate>
                            <DataTemplate x:DataType="domain:GroupHeaderRow">
                                <Border BackgroundColor="{StaticResource Gray900}"
                                        Padding="12,8"
                                        StrokeThickness="0"
                                        Margin="0,12,0,4">
                                    <Grid ColumnDefinitions="*,Auto">
                                        <Label Text="{Binding Title}"
                                               FontSize="16"
                                               FontAttributes="Bold"
                                               TextColor="{StaticResource White}"
                                               VerticalOptions="Center" />
                                        <Label Grid.Column="1"
                                               Text="{Binding Count, StringFormat='{0} items'}"
                                               FontSize="12"
                                               TextColor="{StaticResource Gray400}"
                                               VerticalOptions="Center" />
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </selectors:TimelineRowTemplateSelector.HeaderTemplate>

                        <!-- Tile Row Template -->
                        <selectors:TimelineRowTemplateSelector.TileRowTemplate>
                            <DataTemplate x:DataType="domain:TileRow">
                                <HorizontalStackLayout BindableLayout.ItemsSource="{Binding Items}"
                                                       Spacing="4"
                                                       Padding="4,2">
                                    <BindableLayout.ItemTemplate>
                                        <DataTemplate x:DataType="domain:MediaItem">
                                            <Border Style="{StaticResource GridItemStyle}">
                                                <Border.GestureRecognizers>
                                                    <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type vm:MainViewModel}}, Path=SelectItemCommand}"
                                                                          CommandParameter="{Binding .}" />
                                                    <TapGestureRecognizer NumberOfTapsRequired="2"
                                                                          Command="{Binding Source={RelativeSource AncestorType={x:Type vm:MainViewModel}}, Path=ToggleQuickPreviewCommand}" />
                                                </Border.GestureRecognizers>
                                                <Grid>
                                                    <!-- Thumbnail -->
                                                    <Image Source="{Binding ThumbSmallPath, Converter={StaticResource FilePathConverter}}"
                                                           Aspect="AspectFill" />

                                                    <!-- Favorite indicator -->
                                                    <Label Text="â™¥"
                                                           FontSize="16"
                                                           TextColor="{StaticResource Primary}"
                                                           HorizontalOptions="End"
                                                           VerticalOptions="Start"
                                                           Margin="4"
                                                           IsVisible="{Binding IsFavorite}" />

                                                    <!-- Video overlay -->
                                                    <Grid IsVisible="{Binding Type, Converter={StaticResource IsVideoConverter}}"
                                                          HorizontalOptions="Fill"
                                                          VerticalOptions="Fill">
                                                        <Border BackgroundColor="#80000000"
                                                                WidthRequest="36"
                                                                HeightRequest="36"
                                                                StrokeShape="RoundRectangle 18"
                                                                StrokeThickness="0"
                                                                HorizontalOptions="Center"
                                                                VerticalOptions="Center">
                                                            <Label Text="â–¶"
                                                                   FontSize="18"
                                                                   TextColor="{StaticResource White}"
                                                                   HorizontalOptions="Center"
                                                                   VerticalOptions="Center" />
                                                        </Border>
                                                        <Border BackgroundColor="#B0000000"
                                                                Padding="4,2"
                                                                StrokeThickness="0"
                                                                HorizontalOptions="End"
                                                                VerticalOptions="End"
                                                                Margin="4"
                                                                IsVisible="{Binding Duration, Converter={StaticResource IsNotNullOrEmptyConverter}}">
                                                            <Label Text="{Binding Duration, Converter={StaticResource DurationConverter}}"
                                                                   FontSize="10"
                                                                   TextColor="{StaticResource White}" />
                                                        </Border>
                                                    </Grid>

                                                    <!-- Placeholder -->
                                                    <Border BackgroundColor="{StaticResource Gray700}"
                                                            IsVisible="{Binding ThumbSmallPath, Converter={StaticResource IsNullOrEmptyConverter}}"
                                                            HorizontalOptions="Fill"
                                                            VerticalOptions="Fill">
                                                        <Label Text="{Binding Type, Converter={StaticResource MediaTypeToIconConverter}}"
                                                               FontSize="32"
                                                               TextColor="{StaticResource Gray500}"
                                                               HorizontalOptions="Center"
                                                               VerticalOptions="Center" />
                                                    </Border>
                                                </Grid>
                                            </Border>
                                        </DataTemplate>
                                    </BindableLayout.ItemTemplate>
                                </HorizontalStackLayout>
                            </DataTemplate>
                        </selectors:TimelineRowTemplateSelector.TileRowTemplate>
                    </selectors:TimelineRowTemplateSelector>
                </CollectionView.ItemTemplate>
            </CollectionView>

            <!-- Right Panel: Inspector -->
            <Border Grid.Row="1" Grid.Column="2"
                    BackgroundColor="{StaticResource Gray900}"
                    Stroke="{StaticResource Gray800}"
                    StrokeThickness="1,0,0,0">
                <ScrollView>
                    <VerticalStackLayout Padding="12" Spacing="12">
                        <!-- Preview (clickable for quick preview) -->
                        <Border BackgroundColor="{StaticResource Gray800}"
                                HeightRequest="280"
                                StrokeThickness="0">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding ToggleQuickPreviewCommand}" />
                            </Border.GestureRecognizers>
                            <Grid>
                                <Image Source="{Binding SelectedItem.ThumbLargePath, Converter={StaticResource FilePathConverter}}"
                                       Aspect="AspectFit" />
                                <!-- Hover hint -->
                                <Label Text="Click to enlarge"
                                       TextColor="{StaticResource Gray500}"
                                       FontSize="11"
                                       HorizontalOptions="Center"
                                       VerticalOptions="End"
                                       Margin="0,0,0,8" />
                            </Grid>
                        </Border>

                        <!-- File Info -->
                        <VerticalStackLayout Spacing="8">
                            <Label Text="{Binding SelectedItem.Path}"
                                   TextColor="{StaticResource White}"
                                   FontSize="12"
                                   FontAttributes="Bold"
                                   LineBreakMode="TailTruncation" />

                            <Grid ColumnDefinitions="Auto,*" RowDefinitions="Auto,Auto,Auto,Auto,Auto,Auto" ColumnSpacing="12" RowSpacing="4">
                                <Label Grid.Row="0" Grid.Column="0" Text="Size" TextColor="{StaticResource Gray400}" FontSize="12" />
                                <Label Grid.Row="0" Grid.Column="1" Text="{Binding SelectedItem.SizeBytes, Converter={StaticResource FileSizeConverter}}" TextColor="{StaticResource White}" FontSize="12" />

                                <Label Grid.Row="1" Grid.Column="0" Text="Dimensions" TextColor="{StaticResource Gray400}" FontSize="12" />
                                <Label Grid.Row="1" Grid.Column="1" TextColor="{StaticResource White}" FontSize="12">
                                    <Label.Text>
                                        <MultiBinding StringFormat="{}{0} Ã— {1}">
                                            <Binding Path="SelectedItem.Width" />
                                            <Binding Path="SelectedItem.Height" />
                                        </MultiBinding>
                                    </Label.Text>
                                </Label>

                                <!-- Duration row (only visible for videos) -->
                                <Label Grid.Row="2" Grid.Column="0" Text="Duration" TextColor="{StaticResource Gray400}" FontSize="12"
                                       IsVisible="{Binding SelectedItem.Type, Converter={StaticResource IsVideoConverter}}" />
                                <Label Grid.Row="2" Grid.Column="1" Text="{Binding SelectedItem.Duration, Converter={StaticResource DurationConverter}}" TextColor="{StaticResource White}" FontSize="12"
                                       IsVisible="{Binding SelectedItem.Type, Converter={StaticResource IsVideoConverter}}" />

                                <Label Grid.Row="3" Grid.Column="0" Text="Modified" TextColor="{StaticResource Gray400}" FontSize="12" />
                                <Label Grid.Row="3" Grid.Column="1" Text="{Binding SelectedItem.ModifiedAt, StringFormat='{0:g}'}" TextColor="{StaticResource White}" FontSize="12" />

                                <Label Grid.Row="4" Grid.Column="0" Text="Taken" TextColor="{StaticResource Gray400}" FontSize="12" />
                                <Label Grid.Row="4" Grid.Column="1" Text="{Binding SelectedItem.TakenAt, StringFormat='{0:g}'}" TextColor="{StaticResource White}" FontSize="12" />

                                <Label Grid.Row="5" Grid.Column="0" Text="Type" TextColor="{StaticResource Gray400}" FontSize="12" />
                                <Label Grid.Row="5" Grid.Column="1" Text="{Binding SelectedItem.Extension}" TextColor="{StaticResource White}" FontSize="12" />
                            </Grid>

                            <!-- Actions -->
                            <HorizontalStackLayout Spacing="8" Margin="0,8,0,0">
                                <Button Text="â™¥"
                                        Command="{Binding ToggleFavoriteCommand}"
                                        BackgroundColor="{StaticResource Gray700}"
                                        TextColor="{StaticResource Primary}"
                                        WidthRequest="44"
                                        HeightRequest="44"
                                        CornerRadius="4" />
                                <Button Text="Open"
                                        Command="{Binding OpenInExplorerCommand}"
                                        BackgroundColor="{StaticResource Gray700}"
                                        HeightRequest="44" />
                            </HorizontalStackLayout>
                        </VerticalStackLayout>
                    </VerticalStackLayout>
                </ScrollView>
            </Border>

            <!-- Status Bar -->
            <Grid Grid.Row="2" Grid.ColumnSpan="3"
                  BackgroundColor="{StaticResource Gray900}"
                  Padding="12,6">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <Label Grid.Column="0"
                       Text="{Binding ScanStatus}"
                       TextColor="{StaticResource Gray400}"
                       FontSize="12"
                       VerticalOptions="Center" />

                <Label Grid.Column="1"
                       Text="{Binding ItemCount, StringFormat='{0} items'}"
                       TextColor="{StaticResource Gray400}"
                       FontSize="12"
                       VerticalOptions="Center" />
            </Grid>
        </Grid>

        <!-- Quick Preview Overlay -->
        <Grid x:Name="QuickPreviewContainer"
              IsVisible="{Binding IsQuickPreviewOpen}"
              BackgroundColor="#E0000000">
            <Grid.GestureRecognizers>
                <TapGestureRecognizer Command="{Binding CloseQuickPreviewCommand}" />
            </Grid.GestureRecognizers>

            <!-- Preview Image (for images) -->
            <Image x:Name="QuickPreviewImage"
                   Source="{Binding SelectedItem.ThumbLargePath, Converter={StaticResource FilePathConverter}}"
                   Aspect="AspectFit"
                   Margin="60"
                   IsVisible="{Binding SelectedItem.Type, Converter={StaticResource IsImageConverter}}" />

            <!-- Video Player (for videos) -->
            <toolkit:MediaElement x:Name="QuickPreviewVideo"
                                  Source="{Binding SelectedItem.Path, Converter={StaticResource MediaSourceConverter}}"
                                  ShouldAutoPlay="True"
                                  ShouldShowPlaybackControls="True"
                                  Aspect="AspectFit"
                                  Margin="60"
                                  IsVisible="{Binding SelectedItem.Type, Converter={StaticResource IsVideoConverter}}" />

            <!-- Navigation hints -->
            <HorizontalStackLayout HorizontalOptions="Center"
                                   VerticalOptions="End"
                                   Margin="0,0,0,24"
                                   Spacing="24">
                <Label Text="â† â†’ Navigate"
                       TextColor="{StaticResource Gray400}"
                       FontSize="12" />
                <Label Text="Space/Esc Close"
                       TextColor="{StaticResource Gray400}"
                       FontSize="12" />
            </HorizontalStackLayout>

            <!-- File info -->
            <Border BackgroundColor="#80000000"
                    HorizontalOptions="Start"
                    VerticalOptions="End"
                    Padding="16,8"
                    Margin="24"
                    StrokeThickness="0">
                <Label Text="{Binding SelectedItem.Path}"
                       TextColor="{StaticResource White}"
                       FontSize="12"
                       LineBreakMode="TailTruncation"
                       MaximumWidthRequest="400" />
            </Border>
        </Grid>
    </Grid>
</ContentPage>
